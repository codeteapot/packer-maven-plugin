<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/apt/examples/containerized-rest-endpoint.apt.vm at 2021-12-29
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>Packer Maven Plugin &#x2013; </title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.9.min.js"></script>
<link rel="stylesheet" href="../css/site-fix.css"/>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h2>Packer Maven Plugin</h2>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-12-29<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.0.0</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../plugin-info.html" title="Goals"><span class="none"></span>Goals</a></li>
    <li><a href="../usage.html" title="Usage"><span class="none"></span>Usage</a></li>
    <li><a href="https://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License"><span class="none"></span>License</a></li>
   <li class="nav-header">Examples</li>
    <li class="active"><a href="#"><span class="none"></span>Containerized REST endpoint</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<section>
<h2><a name="Containerized_REST_endpoint"></a>Containerized REST endpoint</h2>
<p>This example explains how to create a Docker container image for running an application that exposes a REST endpoint by implementing a JAX-RS resource. It runs an embedded Tomcat server and creates a context with a Jersey servlet for allocating the resource.</p>
<p>Yes, another image type could be created, such as VirtualBox ISO or Amazon Machine Image. And another application technology could be used as well, such Spring Boot Web for writing REST controllers.</p><section>
<h3><a name="Project_layout"></a>Project layout</h3>
<p>In order to create the Docker image through Packer, a build execution is declared to take place after packaging. In this example, only <code>vars</code> configuration property is used to define two variables, <i>dockerRepository</i> and <i>dockerTag</i>, which will be referenced on Packer template.</p>
<p><b>pom.xml (packer-maven-plugin)</b></p>
<div class="source"><pre class="prettyprint linenums">&lt;plugin&gt;
    &lt;groupId&gt;com.github.codeteapot.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;packer-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;packer-build&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;build&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;install&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;vars&gt;
                    &lt;property&gt;
                        &lt;name&gt;dockerRepository&lt;/name&gt;
                        &lt;value&gt;codeteapot/example-rest&lt;/value&gt;
                    &lt;/property&gt;
                    &lt;property&gt;
                        &lt;name&gt;dockerTag&lt;/name&gt;
                        &lt;value&gt;${project.version}&lt;/value&gt;
                    &lt;/property&gt;
                &lt;/vars&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</pre></div>
<p>By default, the working directory of Packer build command specified by <code>inputDirectory</code> property is <code>${project.build.directory}/packer/input</code>. So, all contents used by Packer must be put there.</p>
<p>One can take advantage of <a class="externalLink" href="https://maven.apache.org/plugins/maven-resources-plugin/examples/copy-resources.html"> copy-resources</a> goal of Maven Resources Plugin to copy needed resources to build the image.</p>
<p>The following snippet copies</p>
<ul>
<li>filtered Packer resources from <code>${basedir}/src/main/packer</code>,</li>
<li>non-filtered web application resources from <code>${basedir}/src/main/webapp</code> and</li>
<li>non-filtered JAR generated by the project</li></ul>
<p>to the suitable destination inside Packer input directory.</p>
<p><b>pom.xml (maven-resources-plugin)</b></p>
<div class="source"><pre class="prettyprint linenums">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.2.0&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;packer-resources&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy-resources&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;generate-resources&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;outputDirectory&gt;${project.build.directory}/packer/input&lt;/outputDirectory&gt;
                &lt;resources&gt;
                    &lt;resource&gt;
                        &lt;directory&gt;${basedir}/src/main/packer&lt;/directory&gt;
                        &lt;filtering&gt;true&lt;/filtering&gt;
                    &lt;/resource&gt;
                &lt;/resources&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;webapp-resources&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy-resources&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;generate-resources&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;outputDirectory&gt;${project.build.directory}/packer/input/tomcat/webapps/ROOT&lt;/outputDirectory&gt;
                &lt;resources&gt;
                    &lt;resource&gt;
                        &lt;directory&gt;${basedir}/src/main/webapp&lt;/directory&gt;
                        &lt;filtering&gt;false&lt;/filtering&gt;
                    &lt;/resource&gt;
                &lt;/resources&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;application-resources&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy-resources&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;outputDirectory&gt;${project.build.directory}/packer/input/lib&lt;/outputDirectory&gt;
                &lt;resources&gt;
                    &lt;resource&gt;
                        &lt;directory&gt;${project.build.directory}&lt;/directory&gt;
                        &lt;include&gt;${project.artifactId}-${project.version}.jar&lt;/include&gt;
                        &lt;filtering&gt;false&lt;/filtering&gt;
                    &lt;/resource&gt;
                &lt;/resources&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</pre></div>
<p>In addition, non-provided dependencies must be available at classpath. In this case, <a class="externalLink" href="https://maven.apache.org/plugins/maven-dependency-plugin/copy-dependencies-mojo.html"> copy-dependencies</a> of Maven Dependency Plugin could be used.</p>
<p>The following snippet shows how to do it.</p>
<p><b>pom.xml (maven-dependency-plugin)</b></p>
<div class="source"><pre class="prettyprint linenums">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.1.2&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;application-dependencies&lt;/id&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy-dependencies&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;outputDirectory&gt;${project.build.directory}/packer/input/lib&lt;/outputDirectory&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</pre></div>
<p>Packer source folder is expected to have the template used by the build command, which is <code>template.json</code> by default, unless another is specified by <code>template</code> configuration parameter. The following one buids a Docker image, based on <i>openjdk:8</i>, that</p>
<ul>
<li>executes a setup script,</li>
<li>copies web application resources, and</li>
<li>copies application JAR and its dependencies to classpath.</li></ul>
<p><b>src/main/packer/template.json</b></p>
<div class="source"><pre class="prettyprint linenums">{
  &quot;variables&quot;: {
    &quot;dockerRepository&quot;: &quot;repository&quot;,
    &quot;dockerTag&quot;: &quot;tag&quot;,
    &quot;tomcatLibDir&quot;: &quot;/var/lib/tomcat&quot;,
    &quot;applicationLibDir&quot;: &quot;/usr/local/lib/application&quot;
  },
  &quot;builders&quot;: [
    {
      &quot;type&quot;: &quot;docker&quot;,
      &quot;image&quot;: &quot;openjdk:8&quot;,
      &quot;commit&quot;: true,
      &quot;changes&quot;: [
        &quot;ENTRYPOINT /init&quot;
      ]
    }
  ],
  &quot;provisioners&quot;: [
    {
      &quot;type&quot;: &quot;shell&quot;,
      &quot;script&quot;: &quot;{{template_dir}}/setup.sh&quot;,
      &quot;environment_vars&quot;: [
        &quot;TOMCAT_LIB_DIR={{ user `tomcatLibDir` }}&quot;,
        &quot;APPLICATION_LIB_DIR={{ user `applicationLibDir` }}&quot;
      ]
    },
    {
      &quot;type&quot;: &quot;file&quot;,
      &quot;source&quot;: &quot;{{template_dir}}/tomcat/&quot;,
      &quot;destination&quot;: &quot;{{ user `tomcatLibDir` }}&quot;
    },
    {
      &quot;type&quot;: &quot;file&quot;,
      &quot;source&quot;: &quot;{{template_dir}}/lib/&quot;,
      &quot;destination&quot;: &quot;{{ user `applicationLibDir` }}&quot;
    }
  ],
  &quot;post-processors&quot;: [
    {
      &quot;type&quot;: &quot;docker-tag&quot;,
      &quot;repository&quot;: &quot;{{ user `dockerRepository` }}&quot;,
      &quot;tag&quot;: &quot;{{ user `dockerTag` }}&quot;
    }
  ]
}
</pre></div>
<p>Variables <i>dockerRepository</i> and <i>dockerTag</i>, defined at <code>packer-build</code> execution configuration, are used here to determine <i>repository</i> and <i>tag</i> respectively of <i>docker-tag</i> post-processor.</p>
<p>Setup script creates the container file-system layout and prepares an <i>init script</i> that acts as the <i>ENTRYPOINT</i> of Docker process.</p>
<p><b>src/main/packer/setup.sh</b></p>
<div class="source"><pre class="prettyprint linenums">#!/bin/sh

mkdir $TOMCAT_LIB_DIR
mkdir $APPLICATION_LIB_DIR

cat &lt;&lt; EOF &gt;&gt; /init
#!/bin/sh
java \
-classpath $APPLICATION_LIB_DIR \
-Dcom.github.codeteapot.maven.plugins.packer.example.tomcatLibDir=$TOMCAT_LIB_DIR \
-jar \
$APPLICATION_LIB_DIR/${project.artifactId}-${project.version}.jar
EOF

chmod +x /init
</pre></div>
<p>Properties <code>project.artifactId</code> and <code>project.version</code> are substituted by their actual values before this file is copied to <code>${project.build.directory}/packer/input</code> directory since it is a filtered resource.</p>
<p>At the end, JAR manifest must be configured to specify main class of this application and to add classpath entries as described on <a class="externalLink" href="https://maven.apache.org/shared/maven-archiver/examples/classpath.html">Set Up The Classpath</a> example of Maven JAR Plugin. In this example, <code>com.github.codeteapot.maven.plugins.packer.example.ExampleService</code> is the main class.</p>
<p><b>pom.xml (maven-jar-plugin)</b></p>
<div class="source"><pre class="prettyprint linenums">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.2.0&lt;/version&gt;
    &lt;configuration&gt;
        &lt;archive&gt;
            &lt;manifest&gt;
                &lt;addClasspath&gt;true&lt;/addClasspath&gt;
                &lt;mainClass&gt;com.github.codeteapot.maven.plugins.packer.example.ExampleService&lt;/mainClass&gt;
            &lt;/manifest&gt;
        &lt;/archive&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;
</pre></div>
<p>As summary, this layout is valid for this example, but a similar approach can be used on many other use cases. The main idea is to run an application through a Docker container. Anyway, this is a most common use case, using a Tomcat embedded server.</p></section><section>
<h3><a name="Application_implementation"></a>Application implementation</h3>
<p>This example REST endpoint is implemented through JAX-RS resource deployed on an embedded Tomcat server using a Jersey servlet.</p>
<p>First of all, a Tomcat instance listening on port 8000 is created. Directory on path specified by <code>com.github.codeteapot.maven.plugins.packer.example.tomcatLibDir</code> system property is used as base directory for allocating server files.</p>
<p>Since it is designed to have only one web application, a single root context is used. There is created a &quot;/index.html&quot; file as welcome one, so root path will serve this file.</p>
<p>Two servlets are configured.</p>
<ul>
<li>The <code>default-servlet</code> is responsible of serving static files.</li>
<li>The <code>jax-rs-servlet</code> is responsible of serving JAX-RS resources.</li></ul>
<p>Server is then ready to be started.</p>
<p><b>src/main/java/com/github/codeteapot/maven/plugins/packer/example/ExampleService.java</b></p>
<div class="source"><pre class="prettyprint linenums">  public static void main(String[] args) throws LifecycleException {
    Tomcat tomcat = new Tomcat();
    tomcat.setPort(8000);
    tomcat.setBaseDir(
        getProperty(&quot;com.github.codeteapot.maven.plugins.packer.example.tomcatLibDir&quot;));
    tomcat.getConnector();

    Context context = tomcat.addContext(&quot;&quot;, &quot;ROOT&quot;);
    context.addWelcomeFile(&quot;/index.html&quot;);

    Wrapper defaultServlet = context.createWrapper();
    defaultServlet.setName(&quot;default-servlet&quot;);
    defaultServlet.setServletClass(&quot;org.apache.catalina.servlets.DefaultServlet&quot;);
    defaultServlet.setLoadOnStartup(1);
    context.addChild(defaultServlet);
    context.addServletMappingDecoded(&quot;/&quot;, &quot;default-servlet&quot;);
    
    Wrapper restServlet = context.createWrapper();
    restServlet.setName(&quot;jax-rs-servlet&quot;);
    restServlet.setServletClass(&quot;org.glassfish.jersey.servlet.ServletContainer&quot;);
    restServlet.addInitParameter(
        &quot;jersey.config.server.provider.packages&quot;,
        &quot;com.github.codeteapot.maven.plugins.packer.example.resources&quot;);
    restServlet.setLoadOnStartup(1);
    context.addChild(restServlet);
    context.addServletMappingDecoded(&quot;/rest/*&quot;, &quot;jax-rs-servlet&quot;);

    tomcat.start();
  }
</pre></div>
<p>Static files comes from <code>${basedir}/main/webapp</code> directory. They are accessible across all root children paths by default.</p>
<p>Welcome file for root path that gives two links to a pair of hypothetical example resources. They are absolute from root and inside the same host, so their references are prefixed by &quot;/rest&quot; context path.</p>
<p><b>src/main/webapp/index.html</b></p>
<div class="source"><pre class="prettyprint linenums">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;REST Example&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;REST Example&lt;/h1&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href=&quot;/rest/examples/1&quot;&gt;Example #1&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&quot;/rest/examples/2&quot;&gt;Example #2&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>On the other hand, &quot;/rest/*&quot; children paths are mapped to be served by Jersey servlet. It scans all JAX-RS-annotated classes inside <code>com.github.codeteapot.maven.plugins.packer.example.resources</code> package in order to instantiate appropriated resource classes.</p>
<p>Here is being an &quot;/examples&quot; resource, items of which are available by its identifier. Single example response represents any example item with its only identifier field.</p>
<p><b>src/main/java/com/github/codeteapot/maven/plugins/packer/example/resources/ExamplesResource.java</b></p>
<div class="source"><pre class="prettyprint linenums">@Path(&quot;/examples&quot;)
@Produces(APPLICATION_JSON)
public class ExamplesResource {

  @GET
  @Path(&quot;/{id}&quot;)
  public Response get(@PathParam(&quot;id&quot;) long id) {
    return status(OK)
        .entity(singletonMap(&quot;id&quot;, id))
        .build();
  }
}
</pre></div>
<p>This application has a little few dependencies.</p>
<dl>
<dt>jakarta.ws.rs-api</dt>
<dd>Makes JAX-RS API available at compile time. It is needed to be non-provided, or else <code>jakarta.ws.rs.ProcessingException</code> is not found at runtime.</dd>
<dt>tomcat-catalina</dt>
<dd>Is used at compile time to instantiate and configure a Tomcat embedded server.</dd>
<dt>jersey-container-servlet-core</dt>
<dd>Makes Jersey servlet class available at runtime.</dd>
<dt>jersey-hk2</dt>
<dd>Is only added to avoid &quot;InjectionManagerFactory&quot; to be not found at runtime.</dd>
<dt>jersey-media-json-jackson</dt>
<dd>Implements a JSON serializer for having a JSON response based on an arbitrary map of resource fields.</dd></dl>
<p><b>pom.xml (dependencies)</b></p>
<div class="source"><pre class="prettyprint linenums">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;jakarta.ws.rs&lt;/groupId&gt;
        &lt;artifactId&gt;jakarta.ws.rs-api&lt;/artifactId&gt;
        &lt;version&gt;3.0.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
        &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;
        &lt;version&gt;10.0.0-M9&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.glassfish.jersey.containers&lt;/groupId&gt;
        &lt;artifactId&gt;jersey-container-servlet-core&lt;/artifactId&gt;
        &lt;version&gt;3.0.0-M6&lt;/version&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.glassfish.jersey.inject&lt;/groupId&gt;
        &lt;artifactId&gt;jersey-hk2&lt;/artifactId&gt;
        &lt;version&gt;3.0.0-M6&lt;/version&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.glassfish.jersey.media&lt;/groupId&gt;
        &lt;artifactId&gt;jersey-media-json-jackson&lt;/artifactId&gt;
        &lt;version&gt;3.0.0-M6&lt;/version&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</pre></div>
<p>All of them, including all transitive dependencies, will be copied along the application artifact inside classpath.</p></section><section>
<h3><a name="Running_container"></a>Running container</h3>
<p>After packaging phase is completed, the Docker image is created. As indicated through variables of build command, its repository is <code>codeteapot/example-rest</code> and its tag is <code>1.0.0</code>, that is equivalent to the artifact version.</p>
<p>A container could be run as follows.</p>
<div class="source"><pre class="prettyprint linenums">$ docker run --rm -it -p 80:8000 codeteapot/example-rest:1.0.0</pre></div>
<p>Mapping port 80 to 8000 permits the application welcome page to be visited at <a class="externalLink" href="http://localhost/">http://localhost/</a>. Port 80 must be free before running it.</p></section><section>
<h3><a name="Example_files"></a>Example files</h3>
<p>Files used to write this example are available here.</p>
<ul>
<li><a href="./rest-container/pom.xml">pom.xml</a></li>
<li><a href="./rest-container/src/main/java/com/github/codeteapot/maven/plugins/packer/example/ExampleService.java">src/main/java/com/github/codeteapot/maven/plugins/packer/example/ExampleService.java</a></li>
<li><a href="./rest-container/src/main/java/com/github/codeteapot/maven/plugins/packer/example/resources/ExamplesResource.java">src/main/java/com/github/codeteapot/maven/plugins/packer/example/resources/ExamplesResource.java</a></li>
<li><a href="./rest-container/src/main/packer/setup.sh">src/main/packer/setup.sh</a></li>
<li><a href="./rest-container/src/main/packer/template.json">src/main/packer/template.json</a></li>
<li><a href="./rest-container/src/main/webapp/index.html">src/main/webapp/index.html</a></li></ul>
<p>Take it into account that these files are used to write snippets for this page, so snippet demarcation comments may be present.</p></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2021
<a href="https://github.com/codeteapot">CodeTeapot</a>
</p>
        </div>
      </div>
    </footer>
  </body>
</html>